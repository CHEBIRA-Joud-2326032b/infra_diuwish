%YAML 1.1
---
suricata-version: "7.0"

vars:
  address-groups:
    HOME_NET: "{{ suricata_home_net }}"
    EXTERNAL_NET: "!$HOME_NET"
    # Serveurs spécifiques (pour règles plus fines plus tard)
    HTTP_SERVERS: "$HOME_NET"
    SQL_SERVERS: "$HOME_NET"
    DNS_SERVERS: "$HOME_NET"

  port-groups:
    HTTP_PORTS: "80"
    SHELLCODE_PORTS: "!80"
    ORACLE_PORTS: 1521
    SSH_PORTS: 22

# --- PERFORMANCE TUNING (LOW RAM / SCHOOL PROJECT) ---
# On réduit drastiquement les allocations mémoire par défaut.
max-pending-packets: 128
runmode: workers

# Détection
detect:
  profile: medium
  # Grouping pour économiser du CPU
  grouping:
    tcp-priority-ports: 80, 443, 22, 5432
    udp-priority-ports: 53

# --- OUTPUTS (LOGGING) ---
outputs:
  # 1. Fast log (pour lecture humaine rapide en cas de pépin)
  - fast:
      enabled: yes
      filename: fast.log
      append: yes

  # 2. EVE JSON (CRITIQUE pour WAZUH)
  - eve-log:
      enabled: yes
      filetype: regular
      filename: eve.json
      types:
        - alert:
            payload: yes             # On garde le payload pour l'analyse forensique
            payload-printable: yes
            packet: yes
            http-body: yes           # Voir ce que le pirate a envoyé
            tagged-packets: yes
        - anomaly:
            enabled: yes
            types:
              applayer: yes
        - http:
            extended: yes
        - dns:
            enabled: yes
        - tls:
            extended: yes
        - ssh:
            enabled: yes
        # On désactive les protocoles inutiles pour gagner des I/O
        - smtp:
            enabled: no
        - ftp:
            enabled: no
        - smb:
            enabled: no
        - flow:
            enabled: no  # Trop verbeux pour l'instant

  # On désactive les logs stats/pcap qui remplissent le disque pour rien
  - stats:
      enabled: no
  - pcap-log:
      enabled: no

# --- APP LAYER PARSERS ---
# On active seulement ce qu'on utilise dans la banque
app-layer:
  protocols:
    tls:
      enabled: yes
      detection-ports:
        dp: 443
    dcerpc:
      enabled: yes
    ftp:
      enabled: yes
    ssh:
      enabled: yes
    smtp:
      enabled: yes
    dns:
      tcp:
        enabled: yes
        detection-ports:
          dp: 53
      udp:
        enabled: yes
        detection-ports:
          dp: 53
    http:
      enabled: yes
      libhtp:
        default-config:
          personality: IDS
          request-body-limit: 4KB
          response-body-limit: 4KB
    # Protocoles désactivés pour économiser la RAM
    modbus:
      enabled: no
    dnp3:
      enabled: no
    enip:
      enabled: no
    nfs:
      enabled: no
    smb:
      enabled: no
    tfpt:
      enabled: no
    mqtt:
      enabled: no

# --- IPS MODE (NFQUEUE) ---
# C'est ICI que la magie opère.
nfq:
  mode: accept        # Si Suricata plante, on laisse passer (fail-open) ou 'drop' (fail-closed)
  repeat-mark: 1
  repeat-mask: 1
  batchcount: 20

# --- RULES ---
default-rule-path: /var/lib/suricata/rules
rule-files:
  - suricata.rules

# --- NETWORK ---
# Désactivé car on utilise NFQUEUE, mais on laisse la section vide pour éviter les erreurs
af-packet: []
pcap: []